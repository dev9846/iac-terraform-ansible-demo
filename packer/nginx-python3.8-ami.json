{
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "ap-south-1",
      "source_ami": "ami-03edbe403ec8522ed",
      "instance_type": "t2.micro",
      "ssh_username": "ec2-user",
      "ssh_keypair_name": "iac-demo-fix",
      "ssh_private_key_file": "/Users/dev/.ssh/iac-demo-fix.pem",
      "ami_name": "iac-nginx-python38-{{timestamp}}",
      "associate_public_ip_address": true,
      "communicator": "ssh"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo yum update -y",
        "sudo amazon-linux-extras enable python3.8",
        "sudo yum clean metadata",
        "sudo yum install -y python3.8 python3.8-pip",
        "sudo amazon-linux-extras enable nginx1",
        "sudo yum install -y nginx openssl",
        "sudo systemctl enable nginx",
        "sudo systemctl start nginx",
        "sudo mkdir -p /etc/ssl/private",
        "sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -subj \"/C=IN/ST=MH/L=Mumbai/O=DevOrg/CN=localhost\" -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt"
      ]
    },
    {
      "type": "ansible",
      "playbook_file": "../ansible/nginx_setup.yml",
      "user": "ec2-user"
    }
  ]
}
